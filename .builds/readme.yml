image: alpine/edge
packages:
  - asciidoctor
  - curl
  - jq
sources:
  - https://git.sr.ht/~gbrlsnchs/park
secrets:
  - 954d52e6-347f-40eb-9234-f819e1b9aca4
tasks:
  - build: |
      cd park
      asciidoctor --no-header-footer --out-file _body.html README.adoc
      sed --in-place '
        s|<div class="title">\(.*\)</div>|<div class="container"><pre>\1</pre></div>|g;
        s|<td class="icon">|<td class="content">|g' _body.html
      echo '<div id="header"><h1>park</h1></div>' > _header.html
      cat _header.html _body.html > README.html
  - update: |
      set +x
      cd park
      jq --slurp --raw-input '{
        "query": "mutation UpdateRepo($id: Int!, $readme: String!) {
          updateRepository(id: $id, input: { readme: $readme }) { id }
        }",
        "variables": {
          "id": 171886,
          "readme": .
        }
      }' < README.html | \
        curl --oauth2-bearer "$(cat ~/.readme-secret)" \
          --header "Content-Type: application/json" \
          --data @- \
          https://git.sr.ht/query
